---
layout: post
title: Reordering rows with a position column in SQL (and a little bit of CF)
summary: One take on reordering data. Given an ID and a direction, we want to reorder rows by updating a position column.
tags: [SQL]
---

<p>One take on reordering data. Given an ID and a direction, we want to reorder rows by updating a position column.</p>
<p>I'm running this on SQL 2000 but it'll be good for 7 and 2005.</p>    <p>We have a listing table with a foreign key to an agent table. We select the position and agentID of the listing row we're looking to move.</p>    <pre style="background: #ff9; padding: 15px;">DECLARE @position INT, @agentID INT        SELECT   @position = position,   @agentID = agentID  FROM listing  WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;></pre>    <p>Then depending on whether we're moving the listing up or down we do one of the following.</p>    <pre style="background: #ff9; padding: 15px;">&lt;cfif ARGUMENTS.direction EQ &quot;down&quot;&gt;     UPDATE listing   SET position = position - 1   WHERE agentID = @agentID   AND position = @position + 1      UPDATE listing   SET position = position + 1   WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;&gt;     &lt;cfelseif ARGUMENTS.direction EQ &quot;up&quot;&gt;     UPDATE listing   SET position = position + 1   WHERE agentID = @agentID   AND position = @position - 1      UPDATE listing   SET position = position - 1   WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;&gt;     &lt;/cfif&gt;</pre>    <p>We update the position of the lising that's in the way. Then we update the position of the listing that's moving.</p>    <p>Wack that in a transaction and you should be good to go. Unless of course, someone tries to move the top listing up or the bottom one down!</p>    <p>We could just ensure that the calling code never tries to, but best to check here in case it get's misused.</p>    <p>We'll add a check to see if we're trying to move the bottom listing down...</p>    <pre style="background: #ff9; padding: 15px;">SELECT @maxPosition = MAX(position) FROM listing WHERE agentID = @agentID         IF (@maxPosition != @position) BEGIN   UPDATE ...  END</pre>    <p>... and the same for the top one moving up...</p>    <pre style="background: #ff9; padding: 15px;">IF (@position != 1) BEGIN   UPDATE ...  END</pre>    <p>So the complete code wrapped in a function might looks like this.</p>    <pre style="background: #ff9; padding: 15px;">&lt;cffunction name=&quot;move&quot;&gt;     &lt;cfargument name=&quot;listingID&quot;&gt;   &lt;cfargument name=&quot;direction&quot;&gt;      &lt;cfquery datasource=&quot;#VARIABLES.DSN#&quot;&gt;       BEGIN TRAN        DECLARE @position INT, @agentID INT, @maxPosition INT          SELECT      @position = position,      @agentID = agentID     FROM listing     WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;&gt;          &lt;cfif ARGUMENTS.direction EQ &quot;down&quot;>           SELECT @maxPosition = MAX(position) FROM listing WHERE agentID = @agentID            IF (@maxPosition != @position) BEGIN            UPDATE listing       SET position = position - 1       WHERE agentID = @agentID       AND position = @position + 1              UPDATE listing       SET position = position + 1       WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;&gt;             END           &lt;cfelseif ARGUMENTS.direction EQ &quot;up&quot;&gt;           IF (@position != 1) BEGIN            UPDATE listing       SET position = position + 1       WHERE agentID = @agentID       AND position = @position - 1              UPDATE listing       SET position = position - 1       WHERE listingID = &lt;cfqueryparam cfsqltype=&quot;CF_SQL_INTEGER&quot; value=&quot;#ARGUMENTS.listingID#&quot;&gt;             END           &lt;/cfif&gt;        COMMIT TRAN       &lt;/cfquery&gt;    &lt;/cffunction&gt;</pre>